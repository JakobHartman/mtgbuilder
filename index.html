<!DOCTYPE html>
<html>
<head>
	<title>index</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<link rel="stylesheet" type="text/css" href="assets/css/bootstrap.min.css">
	<link type="text/css" rel="stylesheet" href="assets/css/global.css" />
	<link type="text/css" rel="stylesheet" href="assets/css/color-button.css" />
	<!-- js Boots_from -->
	<script src="assets/js/jquery.js"></script>
    <script src="assets/js/bootstrap.min.js"></script>
    <script src="https://cdn.firebase.com/js/client/2.2.2/firebase.js"></script>
    <script src="assets/js/custom.js"></script>
    <script type="text/javascript">
    	var ref = new Firebase("https://mtgdeckpricerweb.firebaseio.com/");
    	var cardStock = new Array();
    	var showStock = new Array();
    	var decks = null;
    	var item;
	    $(document).ready(function(){
	    	ref.onAuth(authHandaler)
	    	loadCardsFirst()
	    	$(".refresh").bind("click",refresh)
	    	
	    	
	    })
	    $(function(){
    		$("#searchBar").keyup(function(event){
    			if(event.keyCode != 40 || event.keyCode != 37 || event.keyCode != 38 || event.keyCode != 39){
    				var search = $("#searchBar").val().toLowerCase();
	    			console.log(search)
	    			if(search != ""){
		    			var base = new Firebase("https://magictgdeckpricer.firebaseio.com/allCards/")
		    			base.orderByChild("imageName").startAt(search).limitToFirst(10).once("value",function(data){
							$("#dataList").html("")
							console.log(data.numChildren())
							data.forEach(function(items){
								var item = items.val()
								$("#dataList").append("<option value='" + item.name + "'>")
							})
		    			})
	    			}
    			}
    		})
    	})

	    function refresh(){
	    	cardStock = new Array();
	    	$("#cardShow").html("")
	    	loadCardsFirst()
	    }

	    function aCard(name,set,code,cost,image){
	   		this.name = name;
	   		this.set = set;
	   		this.code = code;
	   		this.image = image
	   		this.cost = "0.99";
	    }


        function authHandaler(authData,error) {
	  		if (authData) {
	  			console.log(authData);
				var newRef = new Firebase("https://mtgdeckpricerweb.firebaseio.com/Users");
				var name = authData.password.email;
				newRef.orderByChild("email").equalTo(name).limitToFirst(1).on("value",function(data){
					data.forEach(function(child){
						$("#userPic").remove();
						$("#userDrop").remove();
						$("#sideboardCount").remove();
						var userData = child.val()
						var side = child.child("sideboard").numChildren()
						$("#loginArea").remove()
						$(".nav.pull-right").append("<li id='userPic' class='avatar_small'><a href='account.html'></a></li>")
						$(".nav.pull-right").append("<li id='userDrop'class='dropdown'><a class='dropdown-toggle' href='#' data-toggle='dropdown' id='usernameSlot'>" + userData["username"] + "<b class='caret'></b></a><ul class='dropdown-menu'><li><a href='profile.html'><i class='icon-user'></i>Account Setting  </a></li><li><a href='setting.html'><i class='icon-lock'></i> Change Password</a></li><li class='divider'></li><li><a id='logoutUser'><i class='icon-off'></i> Logout</a></li></ul></li>")
						$("<li id='sideboardCount'><a href='sideboard.html'>Sideboard: " + side + "</a></li>").insertBefore("#lib")
						$("#logoutUser").bind("click",logout)
						decks = child.child("Decks");
						$("#dropSlots").html("")
						$("#dropSlots").append("<li><a href='decks.html'><i class='icon-plus'></i> New Deck</a></li>")
						decks.forEach(function(deck){
							$("#dropSlots").append("<li><a>" + deck.val().name + "</a></li>")
						})
					})
					
				})
				
	  		} else {
	  				console.log(error)
	  		}
		}

		function checkAuth(authData,error){
			if(authData){
				var ref = new Firebase("https://mtgdeckpricerweb.firebaseio.com/Users");
				var name = authData.password.email;
				console.log(name)
				ref.orderByChild("email").equalTo(name).limitToFirst(1).once("value",function(data){
					data.forEach(function(child){
						var max = child.child("maxSide").val()
						var key = child.key();
						var theName = cardStock[item].name;
						var set = cardStock[item].set
						var code = cardStock[item].code
						var image = cardStock[item].image
						console.log(theName)
						var aRef = new Firebase("https://mtgdeckpricerweb.firebaseio.com/Users/" + key + "/sideboard");
							aRef.once("value",function(data){
								var number = data.numChildren();
								if(number >= max){
									$('.error').text("Sideboard full")
									$('.error').fadeIn(400).delay(3000).fadeOut(400);
								}else{
									var i = aRef.push();
										i.set({"name" : theName ,"owned" : "false" ,"set" : set,"code":code,"image" : image,"uuid":i.name()})
									$('.error').text(theName + " added to sideboard")
									$('.error').fadeIn(400).delay(3000).fadeOut(400);
								}
							})
					})
				})
			} else{
				$('.error').text("Need to login in order to add to sideboard")
				$('.error').fadeIn(400).delay(3000).fadeOut(400);
			}
		}

		function loadCardsFirst () {
			var t = 0
			var setRef = new Firebase("https://magictgdeckpricer.firebaseio.com/SetInfo");
			for(t; t < 12;t++){
				setRef.once("value",function(setName){
					var rand = Math.floor(Math.random() * setName.numChildren());
					console.log( "Number of sets: " + setName.numChildren())
					var set = setName.child(rand).child("code").val();
					var cardRef = new Firebase("https://magictgdeckpricer.firebaseio.com/Cards/" + set);

					cardRef.once("value",function(all){
						var newRand = Math.floor(Math.random() * all.child("cards").numChildren());
						console.log("Number of cards in set: " + all.child("cards").numChildren())
						console.log(rand,newRand)
						var c = all.child("cards").child(newRand).val();
						if(c != null){
							var newCard = new aCard(c.name,all.child("name").val(),set,"0.99",c.imageName)
							cardStock.push(newCard);
						}else{
							t--;
						}
						if(cardStock.length == 12){
							displayTen();
						}
					})
				})
			}
		}

		function displayTen(){
			var index = 0;
			for(index;index < 12;index++){
				$("#loader").remove()
				var setName = cardStock[index]["set"]
				setName = setName.replace("Duel Decks: ","")
				setName = setName.replace("Magic: The Gathering-","")
				setName = setName.replace("Magic: The Gatheringâ€”Conspiracy","Conspiracy")
				
				setName = setName.replace("Duels of the ","")
				setName = setName.replace("Core Set","")
				setName = setName.replace("From the Vault: ","")
				setName = setName.replace("Premium Deck Series: ","")
				setName = setName.replace("Edition ","")
				setName = setName.replace("Introductory","Intro.")
				setName = setName.replace("Duel Decks Anthology,","")
				 
				
				cardStock[index]["image"] = cardStock[index]["image"].replace(/'/g, "\'"); 
				var isName = cardStock[index]["image"]


				$("#cardShow").append("<li class='span3'><div class='thumbnail border-radius-top'><div class='bg-thumbnail-img'><img class='border-radius-top' id='cardImage" + index + "'></div><h5><a href='detail.html'>" + cardStock[index]["name"] + "</a></h5></div><div class='box border-radius-bottom'><p><span class='title_torrent pull-left'>" + setName + "</span><span><ul><li class='number-view pull-right dropdown'><a class='icon-white icon-plus dropdown-toggle-2' data-toggle='dropdown' style='cursor:pointer'></a><ul class='dropdown-menu' id='dropSlotsCard" + index + "'><li><a id='addToSideBoard" + index + "'>Add to sideboard</a><li class='divider'></li></li></ul></li></ul></span></p></div></li>")
				$("#cardImage" + index).bind("click",function(){
					var p = $(this).attr("id").replace("cardImage","") * 1;
					console.log(p)
					var car = cardStock[p]
					$("#showBigCard").attr("src","assets/img/AllSets/" + car["code"]  + "/" + car["image"] + ".jpg")
					$(".bigCard").fadeIn(400);
					$(".bigCard").bind("click",function(){
						$(".bigCard").fadeOut(400);
					})
				})
				$("#cardImage" + index).attr("src","assets/img/AllSets/" + cardStock[index]["code"]  + "/" + isName + ".jpg")
				var i = 0;
				if(decks != null){
					decks.forEach(function(child){
						$("#dropSlotsCard" + index).append("<li id='deck" + index + "" + i + "'><a>" + child.child("name").val() + "</a></li>")
						$("#deck" + index + "" + i).bind("click",function(){

							var url = child.ref().toString();
							console.log(url)
							var thing = $(this).attr("id").replace("deck","");
							thing = thing.substring(0, thing.length - 1) * 1;
							var base = new Firebase(url)
							var s = base.child("cards").push();
							var code = cardStock[thing]["code"];
							var theName = cardStock[thing]["name"];
							s.set({"name" : theName ,"owned" : false ,"set" : setName,"code":code,"image" : isName,"uuid":s.name()})
							$('.error').text(theName + " added to " + child.child("name").val())
							$('.error').fadeIn(400).delay(3000).fadeOut(400);
						})
						i++;
					})
				}
				
				$("#addToSideBoard" + index).bind("click",function(){
					item = $(this).attr("id").replace("addToSideBoard","") * 1;
					console.log(item)
					var ref = new Firebase("https://mtgdeckpricerweb.firebaseio.com");
					ref.onAuth(checkAuth)
				})
			}
			
		}

		function logout(){
			ref.unauth()
			ref.onAuth(authHandaler)
			window.location.replace("index.html");
		}

    
    </script>
	<!-- end Boots_from -->
</head>

<body data-spy="scroll" data-target=".subnav" data-offset="50" data-twttr-rendered="true">

<div class="navbar navbar-fixed-top">
	<div class="navbar-inner">
		<div class="container">
			<a class="brand" href="#">
				<span>MTG</span><span class="cl-blue">Deck Pricer</span>
			</a>
			<div class="nav-collapse">
				<ul class="nav pull-right">
              		<li><a href="index.html">Home</a></li>
              		<li class="dropdown">
            			<a class="dropdown-toggle" href="#" data-toggle="dropdown">
	            			Decks
	            			<b class="caret"></b>
            			</a>
            			<ul class="dropdown-menu" id="dropSlots">
							<li>
								<a href="decks.html">
									<i class="icon-plus"></i>
									New Deck  </a>
							</li>
						</ul>
            		</li>
              		<li id="lib"><a href="element.html">Library</a></li>
              		<li class="divider-vertical"></li>
              		<li id="loginArea"><a href="login.html">Login</a></li>
            	</ul>
			</div>
		</div>
	</div>
</div>
<!-- end navbar -->
<div class="main">
	<div class="container">
		<div class="row">
			<div class="box-wrapper span12">
				<div class="widget">
					<div class="wrapper-search">
						<form class="form-inline form-search border-rd4">
							<input id="searchBar" placeholder="Search Cards" list="dataList" type="text" class="box-text">
							<a href="#"class="btn-search"></a>
							<datalist id="dataList">
							</datalist>
						</form>
					</div>
				</div>
			</div><!-- end box-wrapper -->
		</div>
		<div class="row">
			<div class="box-wrapper  span12">
				
				<div class="row">
					<div class="title span12">
						<h3 class="pull-left">Random Cards <img src="assets/img/icons/Refresh_icon.png" class="refresh"></h3>
						<div class="bigCard" style="display:none"><img id="showBigCard"/></div>
						<div class='error' style='display:none'>Event Created</div>
					</div><!-- end title -->
				</div>
				<div class="">
					<p id="loader">Loading Cards...</p>
				</div>
				<ul id="cardShow" class="thumbnails thumbnails-horizontal">
					
				</ul>
			</div><!-- end  -->
		</div><!-- row -->
				
	</div><!-- end container -->
</div><!-- end main -->
<div class="footer">
	<div class="container">
		<div class="row">
			<div class="span6 logo-vt">
				<a class="brand" href="#">
					<span>MTG</span><span class="cl-blue">Deck Pricer</span>
				</a>
				<span class="coppy_right">
					<p>Lorem ipsum dolor sit </p>
					<p>@2012 All Rights Reserved.</p>
				</span>
			</div>
			<div class="span2">
				<ul class="nav nav-list">
					<li class="nav-header"></li>
					<li><a href="#"></a></li>
					<li><a href="#"></a></li>
					<li></li>
				</ul>
			</div>
			<div class="span2">
				<ul class="nav nav-list">
					<li class="nav-header"></li>
					<li><a href="#"></a></li>
					<li><a href="#"></a></li>
				</ul>
			</div>
			<div class="span2">
				<ul class="nav nav-list">
					<li class="nav-header">Follow Us</li>
					<li><a href="#"><i class="twitter"></i>Twitter</a></li>
					<li><a href="#"><i class="facebook"></i>Facebook</a></li>
					<li><a href="#"><i class="dd"></i>Forum</a></li>
				</ul>
			</div>
		</div>
	</div>
</div>
<!-- end footer -->
</body>
</html>


